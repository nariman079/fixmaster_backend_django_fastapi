name: Production CI/CD Pipeline 

on:
  push:
    branches: 
      - master

permissions:
  contents: read
  security-events: write
  actions: read
  
jobs:
  test:
    runs-on: ubuntu-latest
    environment: prod
    strategy:
      fail-fast: true
      matrix:
        python-version: [3.12]

    steps:  
      - name: Checkout code 
        uses: actions/checkout@v4

      # - name: Install Python 
      #   uses: actions/setup-python@v5
      #   with:
      #     python-version: ${{matrix.python-version}}

      # - name: Install requirements.txt
      #   run: |
      #     pip install --upgrade pip
      #     pip install -r app/requirements.txt

      # # ðŸ” 1. Ð¡Ñ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· ÐºÐ¾Ð´Ð° (SAST)
      # - name: Run bandit 
      #   run: |
      #     pip install bandit
      #     bandit -r . -f json -o bandit-report.json || true

      # - name: Upload artifact 
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: bandit-report
      #     path: bandit-report.json
      
      # # ðŸ” 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÑ… (SCA)
      # - name: Run pip-audit
      #   run: |
      #     pip-audit --format json > sca-report.json || true

      # - name: Upload SCA Report
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: sca-report
      #     path: sca-report.json

      # # ðŸ³ 3. Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¾Ð±Ñ€Ð°Ð·Ð° Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker-Ñ„Ð°Ð¹Ð»Ð°
      - name: Build docker image
        run: docker build -t fixmaster:${{github.sha}} .

      # # ðŸ” 4. Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð·Ð° Ð½Ð° ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ (Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ)
      # - name: Lint Docker image
      #   uses: hadolint/hadolint-action@v3.1.0
      #   continue-on-error: true
      #   with: 
      #     dockerfile: Dockerfile
      #     format: json
      #     output-file: hadolint-report.json
      #     no-fail: true
      
      # - name: Upload Hadolint 
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: hadolint-report
      #     path: hadolint-report.json

      # # 5. Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð·Ð°
      # - name: Scan Image with Trivy
      #   uses: aquasecurity/trivy-action@master
      #   with:
      #     scan-type: "image"
      #     format: "sarif"
      #     output: "trivy-results.sarif"
      #     ignore-unfixed: true
      #     severity: "HIGH,CRITICAL"
      #     image-ref: fixmaster:${{github.sha}}

      # - name: Upload Trivy Report
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: trivy-report
      #     path: trivy-results.sarif

      # - name: Upload SARIF to GitHub Security
      #   uses: github/codeql-action/upload-sarif@v3
      #   with:
      #     sarif_file: trivy-results.sarif

    
      # # # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð² 
      # # - name: Scan repository secrets
      # #   uses: gitleaks/gitleaks-action@v2


      # Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð¾ÐºÐµÑ€Ð° Ð² Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # - name: Push Docker image
      #   run: |
      #     docker tag fixmaster:${{ github.sha }} nariman079i/fixmaster:${{ github.sha }}
      #     docker push nariman079i/fixmaster:${{ github.sha }}
      - name: Build and push images
        run: |
          docker-compose -f docker-compose.yml build
          docker-compose -f docker-compose.yml push
          
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PROD_HOST }} >> ~/.ssh/known_hosts


      - name: Run Ansible Playbook
        run: |
          ansible-playbook -i "${{ secrets.PROD_HOST }}," \
            -u ${{ secrets.PROD_USER }} \
            --private-key ~/.ssh/id_rsa \
            deploy.yml \
            --extra-vars "github_sha=${{ github.sha }}"

     