name: Production CI/CD Pipeline 

on:
  push:
    branches: 
      - master


jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        python-version: [3.12]

    steps: 
      - name: Checkout code 
        uses: actions/checkout@v4

      - name: Install Python 
        uses: actions/setup-python@v5
        with:
          python-version: ${{matrix.python-version}}

      - name: Install requirements.txt
        run: |
          pip install --upgrade pip
          pip install -r app/requirements.txt

      # üîç 1. –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ (SAST)
      - name: Run bandit 
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-report.json || true

      - name: Upload artifact 
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json
      
      # üîç 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö (SCA)
      - name: Run pip-audit
        run: |
          pip-audit --format json > sca-report.json || true

      - name: Upload SCA Report
        uses: actions/upload-artifact@v4
        with:
          name: sca-report
          path: sca-report.json

      # üê≥ 3. –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ Docker-—Ñ–∞–π–ª–∞
      - name: Build docker image
        run: docker build -t fixmaster:${{github.sha}} .

      # üîç 4. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞ –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ (–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ)
      - name: Lint Docker image
        uses: hadolint/hadolint-action@v3.1.0
        continue-on-error: true
        with: 
          dockerfile: Dockerfile
          format: json
          output-file: hadolint-report.json
          no-fail: true
      
      - name: Upload Hadolint 
        uses: actions/upload-artifact@v4
        with:
          name: hadolint-report
          path: hadolint-report.json

      # 5. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞
      - name: Scan Image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "image"
          format: "sarif"
          output: "trivy-results.sarif"
          ignore-unfixed: true
          severity: "HIGH,CRITICAL"
          image-ref: fixmaster:${{github.sha}}

      - name: Upload Trivy Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-results.sarif

      # üöÄ 6. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –î–µ–ø–ª–æ–π –≤ dev-—Å—Ä–µ–¥—É
