name: Production CI/CD Pipeline 

on:
  push:
    branches: 
      - master

permissions:
  contents: read
  security-events: write
  actions: read
  
jobs:
  test:
    runs-on: ubuntu-latest
    environment: prod
    strategy:
      fail-fast: true
      matrix:
        python-version: [3.12]

    steps:  
      - name: Checkout code 
        uses: actions/checkout@v4

      # - name: Install Python 
      #   uses: actions/setup-python@v5
      #   with:
      #     python-version: ${{matrix.python-version}}

      # - name: Install requirements.txt
      #   run: |
      #     pip install --upgrade pip
      #     pip install -r app/requirements.txt

      # # üîç 1. –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ (SAST)
      # - name: Run bandit 
      #   run: |
      #     pip install bandit
      #     bandit -r . -f json -o bandit-report.json || true

      # - name: Upload artifact 
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: bandit-report
      #     path: bandit-report.json
      
      # # üîç 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö (SCA)
      # - name: Run pip-audit
      #   run: |
      #     pip-audit --format json > sca-report.json || true

      # - name: Upload SCA Report
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: sca-report
      #     path: sca-report.json

      # # üê≥ 3. –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ Docker-—Ñ–∞–π–ª–∞
      - name: Build docker image
        run: docker build -t fixmaster:${{github.sha}} .

      # # üîç 4. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞ –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ (–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ)
      # - name: Lint Docker image
      #   uses: hadolint/hadolint-action@v3.1.0
      #   continue-on-error: true
      #   with: 
      #     dockerfile: Dockerfile
      #     format: json
      #     output-file: hadolint-report.json
      #     no-fail: true
      
      # - name: Upload Hadolint 
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: hadolint-report
      #     path: hadolint-report.json

      # # 5. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞
      # - name: Scan Image with Trivy
      #   uses: aquasecurity/trivy-action@master
      #   with:
      #     scan-type: "image"
      #     format: "sarif"
      #     output: "trivy-results.sarif"
      #     ignore-unfixed: true
      #     severity: "HIGH,CRITICAL"
      #     image-ref: fixmaster:${{github.sha}}

      # - name: Upload Trivy Report
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: trivy-report
      #     path: trivy-results.sarif

      # - name: Upload SARIF to GitHub Security
      #   uses: github/codeql-action/upload-sarif@v3
      #   with:
      #     sarif_file: trivy-results.sarif

    
      # # # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤ 
      # # - name: Scan repository secrets
      # #   uses: gitleaks/gitleaks-action@v2


      # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫–µ—Ä–∞ –≤ Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push Docker image
        run: |
          docker tag fixmaster:${{ github.sha }} nariman079i/fixmaster:${{ github.sha }}
          docker push nariman079i/fixmaster:${{ github.sha }}
      
      