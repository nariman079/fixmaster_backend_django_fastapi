name: Production CI/CD Pipeline 

on:
  push:
    branches: 
      - master

permissions:
  contents: read
  security-events: write
  actions: read
  
jobs:
  test:
    runs-on: ubuntu-latest
    environment: prod
    strategy:
      fail-fast: true
      matrix:
        python-version: [3.12]

    steps:  
      - name: Checkout code 
        uses: actions/checkout@v4


      - name: Build docker image
        run: docker build -t fixmaster:${{github.sha}} .

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

    
      - name: Build and push images
        run: |
          docker compose -f docker-compose.yml build
          docker compose -f docker-compose.yml push


      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PROD_HOST }} >> ~/.ssh/known_hosts

      - name: Copy deploy.yml to server
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.PROD_HOST }}      
          username: ${{ secrets.PROD_USER }} 
          key: ${{ secrets.PROD_SSH_KEY }}     
          source: "docker-comose.yml,.env,configs/,Dockerfile"
          target: "/opt/app/"
          
      
      - name: Run Ansible Playbook
        run: |
          ansible-playbook -i "${{ secrets.PROD_HOST }}," \
            -u ${{ secrets.PROD_USER }} \
            --private-key ~/.ssh/id_rsa \
            deploy.yml \
            --extra-vars "github_sha=${{ github.sha }}"

     